<p align="center">
  <img src="./セキュリティ.png" alt="セキュリティイメージ" width="720">
</p>

# セキュリティ説明資料（顧客向け）  
## Tailscale VPN / Tailscale Funnel を用いた分散GPU基盤の安全性と運用方針

本資料は、分散GPU基盤において **Tailscale（VPN）および Tailscale Funnel（インターネット公開機能）** を用いる場合の、  
セキュリティ上の考え方と運用方針を、ビジネスサイドにも理解しやすい形でまとめたものです。

---

## 1. まず結論：安全な「経路」と、守るべき「入口」を分離する設計です

本基盤では、GPUノードへの接続経路として **Tailscale（WireGuardベースの暗号化メッシュVPN）** を採用し、  
必要に応じて **Tailscale Funnel** を使って外部からアクセス可能な入口を構成します。

ここで重要なのは、セキュリティを次の2層に分けて設計している点です。

- **経路の安全性（通信の暗号化・改ざん耐性）**  
  → Tailscale / WireGuard によって担保
- **入口の安全性（誰が使えるか、どこまで使えるか）**  
  → 当社ゲートウェイ層（認証・権限・レート制限等）で担保

つまり「VPNだから安全」という単純な話ではなく、  
**通信経路は堅牢に、入口の制御はサービス側で厳密に**という実運用向けの設計思想です。

---

## 2. Tailscale（VPN）のセキュリティ要点

### 2-1. 通信はエンドツーエンドで暗号化されます

Tailscale は WireGuard を基盤としており、  
ノード間通信は暗号化・認証付きで、盗聴や改ざんに対して耐性があります。

### 2-2. 「参加できる端末・ユーザー」を制御できます

Tailscale は、一般的なVPNと比べて以下の運用がしやすいことが特徴です。

- SSO / MFA を前提にしたデバイス認証
- デバイス単位のアクセス制御（ACL）
- 端末状態（OSや更新状況など）に基づく制限（posture 等）

これにより「許可された端末だけが、分散GPUネットワークに参加できる」状態を作れます。

---

## 3. Tailscale Funnel（インターネット公開）の位置づけ

### 3-1. Funnel は「公開の入口」を作る機能です

Funnel を有効化すると、特定のGPUノード上のサービスを  
`https://<node>.<tailnet>.ts.net/` のようなHTTPSでインターネット公開できます。

この仕組みは「安全なトンネルで公開する」という意味で便利ですが、  
重要な点として **Funnel 単体は認証・権限・課金・レート制御の代替ではありません**。

### 3-2. 入口の制御は、当社ゲートウェイ層で行います

当社基盤では、Funnel で公開されたGPUノードを「直接ユーザーに触らせる」のではなく、  
基本的に次の方針で運用します。

- **Funnel のURLはバックエンド用途（オリジン）として扱う**  
  → 利用者に公開せず、当社ゲートウェイ（API）経由でのみ利用させる
- 利用者向けの入口は、当社ゲートウェイが提供する統一API（単一エンドポイント）とする
- 認証・権限・レート制限・ログ監査をゲートウェイに集約し、実ノードを保護する

これにより、バックエンドGPUが増減しても、入口の統制を一箇所で維持できます。

---

## 4. 想定されるリスクと対策（重要ポイント）

### 4-1. リスク：公開URLが知られると誰でもアクセスできてしまう

Funnel は「HTTPSで公開できる」一方で、  
公開対象サービス（例：ComfyUI）側に認証が無い場合、URLを知っている第三者がアクセス可能になります。

**対策方針：**

- Funnel URL を利用者へ公開しない（バックエンド用途に限定）
- 追加対策として、GPUノード側に **簡易ゲート（共有トークン検証）** を挟み、  
  正規ゲートウェイからのアクセスのみ許可する構成を推奨

### 4-2. リスク：大量アクセス（DoS）によるGPUリソース枯渇

GPU処理は計算コストが高く、過剰なリクエストはサービス劣化・コスト増に直結します。

**対策方針：**

- 当社ゲートウェイで
  - レート制限（IP/ユーザー/トークン単位）
  - 同時実行数制御（キューイング）
  - リクエスト監査ログ
  を実施
- 必要に応じて、前段に追加の保護（WAF/CDN）を組み合わせる

### 4-3. リスク：端末・アカウント侵害による内部アクセス

Tailscale は「参加できる端末」が増えるほど便利ですが、  
認証情報や端末が侵害されると内部ネットワークへのアクセスが発生し得ます。

**対策方針：**

- tailnet 参加者の最小化（必要な端末のみ参加）
- MFA/SSOの徹底
- ACLで最小権限（必要な通信だけ許可）
- 必要に応じて端末状態（posture）による制限を追加

---

## 5. 当社が採用する運用ルール（推奨）

本基盤を「社外提供するサービス」として運用する場合、  
以下のルールを推奨します。

1. **公開入口はゲートウェイに統一する**  
   - 利用者が触れるのは当社が管理する単一APIのみ
2. **Funnelはオリジン用途（バックエンド用）として扱う**  
   - URLは原則非公開、アクセスはゲートウェイからのみ
3. **認証・権限・制限はゲートウェイに集中させる**  
   - 認証（APIキー/JWT）
   - レート制限
   - 監査ログ
4. **Tailscale側は最小権限で運用する**  
   - ACLを厳密に保つ
   - Funnelを有効化できるノード/ユーザーを限定
5. **障害・メンテナンス時も安全に切り替える**  
   - 特定ノードの切り離し、復旧、追加をゲートウェイ側で実施

---

## 6. まとめ

- Tailscale（VPN）は、GPUノード間通信を暗号化・認証付きで保護する「安全な経路」を提供します。
- Tailscale Funnel は、ポート開放を最小限にしつつインターネット公開を可能にする「公開の入口」を提供します。
- しかし、Funnel自体が「認証・権限・DoS対策」を提供するわけではありません。
- そのため当社基盤では、**入口の統制（認証・制限・監査）をゲートウェイ層に集約**し、  
  Funnel はバックエンド接続のための手段として扱います。

この二層構造により、  
「分散GPUを束ねてサービス化する」という目的を実現しながら、  
社外提供に必要なセキュリティと運用容易性を両立します。
